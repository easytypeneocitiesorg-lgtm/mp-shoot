<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Multiplayer Shooter</title>
<style>
body { margin:0; background:#111; color:#eee; font-family:sans-serif; text-align:center; }
#ui { margin:10px; }
canvas { background:#0a0a0f; border:1px solid #222; display:block; margin:10px auto; }
input,button { margin:3px; }
</style>
</head>
<body>
<div id="ui">
  <button id="createBtn">Create Room</button>
  <input id="codeInput" placeholder="Room code" maxlength="4" style="width:60px" />
  <button id="joinBtn">Join</button>
  <div id="status"></div>
</div>

<canvas id="game" width="640" height="480"></canvas>

<script>
const ws = new WebSocket(location.origin.replace(/^http/, "ws") + "/api/server");
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const codeInput = document.getElementById("codeInput");

let id = null, room = null;
let players = {}; // id â†’ {x,y,dir,hp}
let bullets = [];

let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);
canvas.addEventListener("click", e => shoot(e));

let x = 320, y = 240, dir = 0, hp = 100;

function shoot(e) {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  dir = Math.atan2(my - y, mx - x);
  const b = {x, y, dx: Math.cos(dir)*300, dy: Math.sin(dir)*300};
  bullets.push(b);
  send({t:"bullet", b});
}

function send(obj){ if(ws.readyState===1) ws.send(JSON.stringify(obj)); }

document.getElementById("createBtn").onclick = () => send({t:"create"});
document.getElementById("joinBtn").onclick = () => {
  const code = codeInput.value.trim();
  if (code) send({t:"join", code});
};

ws.onmessage = (ev) => {
  const d = JSON.parse(ev.data);

  if(d.t === "room") {
    // Host created room
    room = d.code;
    id = d.id;
    statusEl.textContent = "Room created! Share the code with a friend";
    codeInput.value = room; // auto-fill input box
  } else if(d.t === "joined") {
    room = d.code;
    id = d.id;
    statusEl.textContent = "Joined room: " + room;
  } else if(d.t === "state" || d.t === "bullet" || d.t === "join" || d.t === "leave") {
    handle(d);
  } else if(d.t === "error") {
    statusEl.textContent = "Error: " + d.msg;
  }
};

function handle(d) {
  if(d.t === "state") players[d.id] = d;
  if(d.t === "bullet") bullets.push(d.b);
  if(d.t === "leave") delete players[d.id];
}

let last = performance.now();
function loop(now){
  const dt = (now - last)/1000; last = now;
  const speed = 150;
  if(keys["w"]) y -= speed*dt;
  if(keys["s"]) y += speed*dt;
  if(keys["a"]) x -= speed*dt;
  if(keys["d"]) x += speed*dt;
  if(room && id) send({t:"state", x, y, dir, hp});

  bullets.forEach(b => { b.x += b.dx*dt; b.y += b.dy*dt; });
  bullets = bullets.filter(b => b.x>0&&b.x<canvas.width&&b.y>0&&b.y<canvas.height);

  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#0ff"; ctx.fillRect(x-10,y-10,20,20);
  for(const pid in players){
    const p = players[pid];
    ctx.fillStyle="#f77"; ctx.fillRect(p.x-10,p.y-10,20,20);
  }
  ctx.fillStyle="#fff";
  bullets.forEach(b => ctx.fillRect(b.x-3,b.y-3,6,6));
}
</script>
</body>
</html>
